public class Solution {
    private const int Modulo = 12345;

    public int[][] ConstructProductMatrix(int[][] grid)
    {
        var prefixProduct = new long[grid.Length * grid[0].Length];
        var invertedPrefixProduct = new long[grid.Length * grid[0].Length];
        var element = 0;

        for (int row = 0; row < grid.Length; row++)
        {
            for (int column = 0; column < grid[0].Length; column++)
            {
                var previousElement = element - 1 >= 0 ? prefixProduct[element - 1] : 1;
                prefixProduct[element] = (previousElement * grid[row][column]) % Modulo;
                element++;
            }
        }

        element = invertedPrefixProduct.Length - 1;
        for (int row = grid.Length - 1; row >= 0; row--)
        {
            for (int column = grid[0].Length - 1; column >= 0; column--)
            {
                var previousElement = element + 1 > invertedPrefixProduct.Length - 1
                    ? 1
                    : invertedPrefixProduct[element + 1];
                invertedPrefixProduct[element] = (previousElement * grid[row][column]) % Modulo;
                element--;
            }
        }

        for (int i = 0; i < prefixProduct.Length; i++)
        {
            var leftProduct = i - 1 < 0 ? 1 : prefixProduct[i - 1];
            var rightProduct = i + 1 > prefixProduct.Length - 1 ? 1 : invertedPrefixProduct[i + 1];

            var row = i / grid[0].Length;
            var column = i % grid[0].Length;
            var result = (leftProduct * rightProduct) % Modulo;

            grid[row][column] = (int)result;
        }

        return grid;
    }
}
